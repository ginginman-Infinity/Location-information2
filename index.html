<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>位置情報の送信</title>
  <script type="module">
    import { createClient } from "https://esm.sh/@supabase/supabase-js@2";
    import { SUPABASE_URL, SUPABASE_KEY } from "./config.js";

    const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);

    const params = new URLSearchParams(location.search);
    const id = params.get("id") || crypto.randomUUID();

    window.addEventListener('load', () => {
      setTimeout(() => getLocation(), 1000);
    });

    async function getLocation() {
      document.body.innerHTML = "<h3>位置情報を取得中...</h3>";

      navigator.geolocation.getCurrentPosition(
        async pos => {
          const lat = pos.coords.latitude;
          const lon = pos.coords.longitude;

          const { error } = await supabase
            .from("locations")
            .upsert({ id, latitude: lat, longitude: lon });

          if (error) {
            document.body.innerHTML = `<p>送信エラー: ${error.message}</p>`;
          } else {
            document.body.innerHTML = `
              <h3>送信完了</h3>
              <p>ありがとうございました！</p>
            `;
          }
        },
        err => {
          document.body.innerHTML = `<p>位置情報が取得できませんでした: ${err.message}</p>`;
        }
      );
    }
  </script>
</head>
<body>
  <h2>位置情報の確認中...</h2>
</body>
</html>
